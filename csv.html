<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heroscape Card Form</title>
    <link rel="stylesheet" href="./css/index.css" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/pdf-lib"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.1.1/compressor.min.js"></script>
    
    <script type="module">
        import { fillOutCSV } from './js/helpers.js';
        import { callAddFontImpact } from './fonts/impact-normal.js';
        import { callAddFontArialbd } from './fonts/arial-bold.js';
        import { callAddFontArial } from './fonts/arial-normal.js';  
        import { initializePDF, generateIndexCard,  saveMergedPDF, mergePDFs } from './js/generatePDF.js';
        import { addPageOne } from './js/pageOne.js';
        import { addPageTwo } from './js/pageTwo-Standard.js';
        import {readCSVFile, readZipFile} from "./js/fileHelper.js";
        import {getImageDataUrl} from "./js/imageHelper.js"
        
        const processingDiv = document.getElementById('processing');
        processingDiv.innerHTML = '';
        const errorMessagesDiv = document.getElementById('errorMessages');
        errorMessagesDiv.innerHTML = '';

        var formData;
        var csvRows;
        var zipData;
    
        async function processFiles() {
            const spinner = Array.from(document.getElementsByClassName('spinner'));
            try{
                processingDiv.innerHTML = '';
                errorMessagesDiv.innerHTML = '';

                const csvFileInput = document.getElementById('csvFile');
                const zipFileInput = document.getElementById('AssetsZip');
            
                if (csvFileInput.files.length === 0 ) {
                    alert('Please select a CSV files.');
                    return;
                }
                spinner.forEach(x => x.style.display = 'grid'); // Show the spinner
            
                const csvFile = csvFileInput.files[0];
                const zipFile = zipFileInput.files[0];
            
                processingDiv.innerHTML = `Reading ${zipFile.name}`;
                // Read the ZIP file
                if(zipFileInput.files.length > 0){
                    zipData = await readZipFile(zipFile);
                }

                processingDiv.innerHTML = `Reading ${csvFile.name}`;
                const csvData = await readCSVFile(csvFile);

                // Parse the CSV data
                parseCSVData(csvData);

                //JsPDF can't handle creating PDFs over 25 pages. This creates 24 page PDFs.
                const chunkSize = 12;
                const pdfChunks = [];
                let pdfNum = 1;
                for (let i = 0; i < csvRows.length; i += chunkSize) {
                    const chunk = csvRows.slice(i, i + chunkSize);
                    let doc = initializePDF();

                    for(const formData of chunk){
                        processingDiv.innerHTML = `Processing PDF ${pdfNum} of ${csvRows.length}, ${formData.unitName}.`;
                        await parseImages(formData);
                        await generateIndexCard(doc, formData);
                        pdfNum++;
                    }
                    const pdfBlob = doc.output('blob');
                    pdfChunks.push(pdfBlob);
                }

                // Save the PDF
                processingDiv.innerHTML = `Compiling PDF.`;
                //Merge each 24 page PDF into one giant PDF.
                const mergedPdf = await mergePDFs(pdfChunks);

                processingDiv.innerHTML = `Sending PDF to browser for download.`;
                saveMergedPDF(mergedPdf, `Heroscape_Index_Army_Cards_${csvRows.length}.pdf`);

                processingDiv.innerHTML = `Processing Complete`
            } catch (error) {
                console.error('Error processing files:', error);
                errorMessagesDiv.innerHTML = `Processing Error: ${error}`;
            } finally {
                spinner.forEach(x => x.style.display = 'none'); // Hide the spinner
            }
        }

        // Function to parse the CSV data
        function parseCSVData(csvData) {
            Papa.parse(csvData, {
                header: true,
                complete: function(results) {
                    csvRows = results.data.map(row => {
                        return {
                            unitGeneral: row["General"].trim(),
                            unitName: row["Name"].trim(),
                            unitRace: row["Race"].trim(),
                            unitRole: row["Role"].trim(),
                            unitPersonality: row["Personality"].trim(),
                            unitPlanet: row["Planet"].trim(),
                            unitType: row["Type"].trim(),
                            unitRarity: row["Rarity"].trim(),
                            unitSizeCategory: row["SizeCategory"].trim(),
                            unitSize: row["Size"].trim(),
                            life: row["Life"].trim(),
                            advancedMove: row["AdvMove"].trim(),
                            advancedRange: row["AdvRange"].trim(),
                            advancedAttack: row["AdvAttack"].trim(),
                            advancedDefense: row['AdvDefense'].trim(),
                            points: row['Points'].trim(),
                            basicMove: row['BasicMove'].trim(),
                            basicRange: row['BasicRange'].trim(),
                            basicAttack: row['BasicAttack'].trim(),
                            basicDefense: row['BasicDefense'].trim(),
                            hitboxImage: row['HitboxImg'].trim(), // File upload
                            unitImageAdvanced: row['AdvImg'].trim(), // File upload
                            unitImageBasic: row['BasicImg'].trim(), // File upload
                            set: row['Set'].trim(),
                            unitNumbers: row['UnitNumbers'].trim(),
                            numberOfUnitsInSet: row['UnitsInSet'].trim(),
                            abilities: row["Abilities"].split("|").map(x => x.split("__")).map(x => { return { name: x[0]?.trim(), text: x[1]?.trim() }})
                        };                     
                    });
                },
                error: function(error) {
                    console.error('Error parsing CSV:', error);
                    throw error;
                }
            });
        }
        
        async function parseImages(formData){
            formData.hitboxImage = await getImageDataUrl(formData.hitboxImage, zipData);
            formData.unitImageBasic = await getImageDataUrl(formData.unitImageBasic, zipData);
            formData.unitImageAdvanced = await getImageDataUrl(formData.unitImageAdvanced, zipData);
        }

        // Make processFiles globally accessible
        window.processFiles = processFiles;
        
        //fillOutCSV();
    </script>
</head>
<body>
    <div class="container">
        <h1>Heroscape Index Card Creator - Batch from CSV</h1>
        <form id="heroscapeForm">            
            <div>
                <label for="csvFile">
                    CSV File
                    <span class="tooltip">[?]
                        <span class="tooltiptext"> Upload a CSV file.</span>
                    </span>
                </label>
                <input type="file" id="csvFile" accept=".csv">
            </div>
            <div>
                <label for="AssetsZip">
                    Zip file with all the image assets 
                    <span class="tooltip">[?]
                        <span class="tooltiptext">Create a zip file with all of the image assets needed for creation of these PDFs</span>
                    </span>
                </label>
                <input type="file" id="AssetsZip" accept=".zip">
            </div>
            <button type="button" onclick="processFiles()">Generate Heroscape Card</button>
        </form>
        <div class="spinner" class="spinner"></div>
        <div id="processing" style="color: green;padding: 50px 0;"></div>
        <div id="errorMessages" style="color: red;"></div>
    </div>
</body>
</html>
