<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../Images/WKnight.ico" type="image/x-icon">
    <link rel="icon" href="../images/WKnight.png" type="image/png">
    <title>Heroscape Builder - Card Generator</title>
    <link rel="stylesheet" href="./css/cardMaker.css" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/pdf-lib"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.1.1/compressor.min.js"></script>
    
    <script type="module">
        //python -m http.server

        import { fillOutCSV } from './js/helpers.js';
        import { callAddFontImpact } from './fonts/impact-normal.js';
        import { callAddFontArialbd } from './fonts/arial-bold.js';
        import { callAddFontArial } from './fonts/arial-normal.js';  
        import { initializePDF, generateIndexCard,  saveMergedPDF, mergePDFs, savePDF } from './js/generatePDF.js';
        import {readCSVFile, readZipFile} from "./js/fileHelper.js";
        import {getImageDataUrl} from "./js/imageHelper.js"
        
        const processingDiv = document.getElementById('processing');
        processingDiv.innerHTML = '';
        const errorMessagesDiv = document.getElementById('errorMessages');
        errorMessagesDiv.innerHTML = '';

        var formData;
        var csvRows;
        var zipData;
    
        async function processFiles() {
            const spinner = Array.from(document.getElementsByClassName('spinner'));
            try{
                processingDiv.innerHTML = '';
                errorMessagesDiv.innerHTML = '';

                const csvFileInput = document.getElementById('csvFile');
                const zipFileInput = document.getElementById('AssetsZip');
                const pdfPages = document.getElementById('PdfPages').value.trim();
            
                if (csvFileInput.files.length === 0 ) {
                    alert('Please select a CSV files.');
                    return;
                }
                spinner.forEach(x => x.style.display = 'grid'); // Show the spinner
            
                const csvFile = csvFileInput.files[0];
                const zipFile = zipFileInput.files[0];
            
                processingDiv.innerHTML = `Reading ${zipFile.name}`;
                // Read the ZIP file
                if(zipFileInput.files.length > 0){
                    zipData = await readZipFile(zipFile);
                }

                processingDiv.innerHTML = `Reading ${csvFile.name}`;
                const csvData = await readCSVFile(csvFile);

                var size = document.getElementById('cardsize').value.trim();
                // Parse the CSV data
                parseCSVData(csvData, size);

                let pdfNum = 1;                
                if(pdfPages == "Single"){
                    //JsPDF can't handle creating PDFs over 25 pages. This creates 24 page PDFs.
                    const chunkSize = 12;
                    const pdfChunks = [];
                    for (let i = 0; i < csvRows.length; i += chunkSize) {
                        const chunk = csvRows.slice(i, i + chunkSize);
                        let doc = initializePDF(size);

                        for(const formData of chunk){
                            processingDiv.innerHTML = `Processing PDF ${pdfNum} of ${csvRows.length}, ${formData.unitName}.`;
                            await parseImages(formData);
                            await generateIndexCard(doc, formData, size);
                            pdfNum++;
                        }
                        const pdfBlob = doc.output('blob');
                        pdfChunks.push(pdfBlob);
                    }

                    // Save the PDF
                    processingDiv.innerHTML = `Compiling PDF.`;
                    //Merge each 24 page PDF into one giant PDF.
                    const mergedPdf = await mergePDFs(pdfChunks);

                    processingDiv.innerHTML = `Sending PDF to browser for download.`;
                    saveMergedPDF(mergedPdf, `Heroscape_Index_Army_Cards_${csvRows.length}.pdf`);
                }else{
                    for(const formData of csvRows){
                        let doc = initializePDF(size);
                        processingDiv.innerHTML = `Processing PDF ${pdfNum} of ${csvRows.length}, ${formData.unitName}.`;
                        await parseImages(formData);
                        await generateIndexCard(doc, formData, size);
                        processingDiv.innerHTML = `Sending PDF to browser for download.`;
                        await savePDF(doc, `Index_${size}_${formData.unitName.replace(" ", "_")}.pdf`);
                        pdfNum++;
                    }
                }

                processingDiv.innerHTML = `Processing Complete`
            } catch (error) {
                console.error('Error processing files:', error);
                errorMessagesDiv.innerHTML = `Processing Error: ${error}`;
            } finally {
                spinner.forEach(x => x.style.display = 'none'); // Hide the spinner
            }
        }

        // Function to parse the CSV data
        function parseCSVData(csvData, size) {
            Papa.parse(csvData, {
                header: true,
                complete: function(results) {
                    csvRows = results.data.map(row => {
                        return {
                            create: row["Create"].trim(),
                            creator: row["Creator"].trim(),
                            unitGeneral: row["General"].trim(),
                            unitName: row["Name"].trim(),
                            unitRace: row["Race"].trim(),
                            unitRole: row["Role"].trim(),
                            unitPersonality: row["Personality"].trim(),
                            unitPlanet: row["Planet"].trim(),
                            unitType: row["Type"].trim(),
                            unitRarity: row["Rarity"].trim(),
                            unitSizeCategory: row["SizeCategory"].trim(),
                            unitSize: row["Size"].trim(),
                            life: row["Life"].trim(),
                            advancedMove: row["AdvMove"].trim(),
                            advancedRange: row["AdvRange"].trim(),
                            advancedAttack: row["AdvAttack"].trim(),
                            advancedDefense: row['AdvDefense'].trim(),
                            points: row['Points'].trim(),
                            basicMove: row['BasicMove'].trim(),
                            basicRange: row['BasicRange'].trim(),
                            basicAttack: row['BasicAttack'].trim(),
                            basicDefense: row['BasicDefense'].trim(),
                            hitboxImage: row['HitboxImg'].trim(), // File upload
                            unitImageAdvanced: row[`AdvImg-${size}`].trim(), // File upload
                            unitImageBasic: row['BasicImg'].trim(), // File upload
                            set: row['Set'].trim(),
                            unitNumbers: row['UnitNumbers'].trim(),
                            numberOfUnitsInSet: row['UnitsInSet'].trim(),
                            abilities: row["Abilities"].split("|").map(x => x.split("__")).map(x => { return { name: x[0]?.trim(), text: x[1]?.trim() }})
                        };                     
                    }).filter(x => x.create == "TRUE");
                },
                error: function(error) {
                    console.error('Error parsing CSV:', error);
                    throw error;
                }
            });
        }
        
        async function parseImages(formData){
            formData.hitboxImage = await getImageDataUrl(formData.hitboxImage, zipData);
            formData.unitImageBasic = await getImageDataUrl(formData.unitImageBasic, zipData);
            formData.unitImageAdvanced = await getImageDataUrl(formData.unitImageAdvanced, zipData);
        }

        // Make processFiles globally accessible
        window.processFiles = processFiles;
        
        //fillOutCSV();
    </script>
</head>
<body>
    <div class="container">
        <h1>Heroscape Index Card Creator - Batch from CSV</h1>
        <form id="heroscapeForm"> 
            <div>
                <label for="cardsize">
                    Index Card Size
                    <span class="tooltip">[?]
                        <span class="tooltiptext">
                            What size index card do you want to make?
                        </span>
                    </span>
                </label>
                <select id="cardsize">
                    <option value="4x6">4x6 Index Card (Landscape)</option>
                    <option value="3x5">3x5 Index Card (Portrait)</option>                    
                    <option value="Standard">Standard Army Card</option>
                </select>
            </div>
            <div>
                <label for="PdfPages">
                    PDF(s) Seperation
                    <span class="tooltip">[?]
                        <span class="tooltiptext"> When reciving the PDFs do you want one giant PDF with all the cards or do you want one PDF per card</span>
                    </span>
                </label>
                
                <select id="PdfPages">
                    <option value="Split">PDF per Army Card</option>
                    <option value="Single">Single PDF</option>
                </select>
            </div>           
            <div>
                <label for="csvFile">
                    CSV File
                    <span class="tooltip">[?]
                        <span class="tooltiptext"> Upload a CSV file.</span>
                    </span>
                </label>
                <input type="file" id="csvFile" accept=".csv">
            </div>
            <div>
                <label for="AssetsZip">
                    Zip file with all the image assets 
                    <span class="tooltip">[?]
                        <span class="tooltiptext">Create a zip file with all of the image assets needed for creation of these PDFs</span>
                    </span>
                </label>
                <input type="file" id="AssetsZip" accept=".zip">
            </div>
            <button type="button" onclick="processFiles()">Generate Heroscape Card</button>
        </form>
        <div class="spinner" class="spinner"></div>
        <div id="processing" style="color: green;padding: 50px 0;"></div>
        <div id="errorMessages" style="color: red;"></div>
    </div>
    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="Abnoba12" data-description="Support me on Buy me a coffee!" data-message="" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18"></script>
</body>
</html>
